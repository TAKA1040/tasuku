// Task Generator Hook - Phase 3: Background Generation System
// Based on RECURRING_REDESIGN_LOG.md specification

'use client'

import { useState, useCallback, useEffect } from 'react'
import { withErrorHandling } from '@/lib/utils/error-handler'
import { logger } from '@/lib/utils/logger'

interface UseTaskGeneratorResult {
  isGenerating: boolean
  lastError: string | null

  // Manual generation trigger
  generateMissingTasks: (forceToday?: boolean) => Promise<void>

  // Auto-generation on mount
  hasAutoGenerated: boolean
}

export function useTaskGenerator(autoGenerate: boolean = true): UseTaskGeneratorResult {
  const [isGenerating, setIsGenerating] = useState(false)
  const [lastError, setLastError] = useState<string | null>(null)
  const [hasAutoGenerated, setHasAutoGenerated] = useState(false)

  // Manual generation triggerï¼ˆAPI RouteçµŒç”±ã§å®Ÿè¡Œï¼‰
  const generateMissingTasks = useCallback(async (forceToday?: boolean) => {
    if (isGenerating) return // Prevent concurrent generation

    await withErrorHandling(
      async () => {
        setIsGenerating(true)
        setLastError(null)

        logger.info('ðŸ”„ ã‚¿ã‚¹ã‚¯ç”Ÿæˆã‚’é–‹å§‹...')

        // API Routeã‚’å‘¼ã³å‡ºã—ï¼ˆã‚µãƒ¼ãƒãƒ¼å´ã§å®Ÿè¡Œï¼‰
        const response = await fetch('/api/generate-tasks', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ forceToday }),
        })

        if (!response.ok) {
          const error = await response.json()
          throw new Error(error.details || error.error || 'ã‚¿ã‚¹ã‚¯ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸ')
        }

        logger.info('âœ… ã‚¿ã‚¹ã‚¯ç”Ÿæˆå®Œäº†')

        // ã‚¿ã‚¹ã‚¯ä¸€è¦§ã‚’è‡ªå‹•ãƒªãƒ­ãƒ¼ãƒ‰ã™ã‚‹ãŸã‚ã®ã‚¤ãƒ™ãƒ³ãƒˆã‚’ç™ºç«
        logger.info('ðŸ“¢ Dispatching tasksUpdated event...')
        window.dispatchEvent(new CustomEvent('tasksUpdated'))
      },
      'useTaskGenerator.generateMissingTasks',
      setLastError
    )

    setIsGenerating(false)
  }, [isGenerating])

  // Auto-generation on component mount
  useEffect(() => {
    if (autoGenerate && !hasAutoGenerated && !isGenerating) {
      generateMissingTasks().then(() => {
        setHasAutoGenerated(true)
      })
    }
  }, [autoGenerate, hasAutoGenerated, isGenerating, generateMissingTasks])

  return {
    isGenerating,
    lastError,
    generateMissingTasks,
    hasAutoGenerated
  }
}