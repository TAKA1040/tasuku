# NextAuth.js Google OAuth ログインエラー解決記録

## 発生したエラー

```
エラー 401: invalid_client
リクエストの詳細: flowName=GeneralOAuthFlow
The OAuth client was not found.
```

## 原因（2つ）

### 1. 間違ったGoogle OAuth Credentials

**問題**: 別プロジェクト（manarieDB）のGoogle OAuth Client ID/Secretを使用していた

- 誤: `1012505741218-00ap1f6fds0nu42enav4gkdh97faju72.apps.googleusercontent.com`（manarieDB用）
- 正: `769162526023-5geuq9tbbn01mvcl5bldsh20sjun0mkc.apps.googleusercontent.com`（tasuku用）

**教訓**: プロジェクトごとにGCP OAuth Clientが異なる場合がある。必ず該当プロジェクトの `.env` を確認すること。

### 2. Vercel環境変数に改行が混入

**問題**: `echo` コマンドでVercel環境変数を設定すると、末尾に改行 `\n` が含まれる

```bash
# NG: 改行が含まれる
echo "YOUR_VALUE" | vercel env add VAR_NAME production

# 結果: AUTH_GOOGLE_ID="769162526023-...apps.googleusercontent.com\n"  ← \n が入る
```

**解決策**: `printf` を使用して改行なしで設定

```bash
# OK: 改行なし
printf "YOUR_VALUE" | vercel env add VAR_NAME production
```

**確認方法**:
```bash
vercel env pull .env.vercel --environment production -y
grep "AUTH_GOOGLE" .env.vercel
# 末尾に \n があれば問題
```

## 正しい設定手順

### 1. 環境変数の確認
```bash
# プロジェクトの.envを確認（マスター台帳）
grep "GOOGLE" /c/Windsurf/tasuku/.env
```

### 2. Vercel環境変数の設定（printf使用）
```bash
printf "YOUR_CLIENT_ID" | vercel env add AUTH_GOOGLE_ID production
printf "YOUR_CLIENT_SECRET" | vercel env add AUTH_GOOGLE_SECRET production
printf "YOUR_AUTH_SECRET" | vercel env add AUTH_SECRET production
```

### 3. 設定確認
```bash
vercel env pull .env.vercel --environment production -y
cat .env.vercel | grep AUTH
# 値の末尾に \n がないことを確認
```

### 4. 再デプロイ
```bash
vercel --prod --yes
```

## GCP Redirect URI設定

NextAuthは `/api/auth/callback/google` を使用する（Supabaseの `/auth/callback` とは異なる）

**必要なRedirect URI:**
- `https://tasuku.apaf.me/api/auth/callback/google`
- `http://localhost:3000/api/auth/callback/google`

## 関連ファイル

- `.env` - マスター台帳（Google OAuth credentials含む）
- `.env.local` - ローカル開発用
- `src/auth.ts` - NextAuth設定（AUTH_GOOGLE_ID, AUTH_GOOGLE_SECRET使用）
