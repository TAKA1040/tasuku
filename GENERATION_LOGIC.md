# 繰り返しタスク生成ロジックの設計

## 問題分析

### 元の実装の問題点
- 週次: 翌週日曜まで生成 → **未来7日分が無駄に蓄積**
- 月次: 1年後まで生成 → **未来365日分が無駄に蓄積**
- 年次: 未実装だが、同様の問題が発生する

### 要件
1. 過去のタスクを見逃さない（月1回のタスクなど）
2. 未来のタスクを事前生成しない（データベース肥大化防止）
3. ユーザーがアクセスした時点で必要なタスクが存在する

## 正しい生成ロジック

### 基本原則
**「過去〜今日まで」のタスクのみ生成**

### パターン別の生成期間

#### 1. DAILY（日次）
- 生成期間: **今日を含めた3日間**（一昨日〜今日）
- 理由: 毎日アクセスすれば昨日・今日が表示される
- 3日前まで: 2〜3日アクセスがなくても大丈夫

#### 2. WEEKLY（週次）
- 生成期間: **過去2週間〜今日**
- 理由:
  - 週1回のタスク → 前週の該当曜日を含める
  - 2週間アクセスなし → 過去2週分のタスクが表示される
- 例: 毎週月曜 → 先週月曜・今週月曜を生成

#### 3. MONTHLY（月次）
- 生成期間: **過去2ヶ月〜今日**
- 理由:
  - 月1回のタスク（例: 家賃支払い）
  - 前月の該当日を含める
  - 2ヶ月アクセスなし → 過去2ヶ月分のタスクが表示される
- 例: 毎月1日 → 先月1日・今月1日を生成

#### 4. YEARLY（年次）
- 生成期間: **過去2年〜今日**
- 理由:
  - 年1回のタスク（例: 誕生日、記念日）
  - 前年の該当日を含める
  - 2年アクセスなし → 過去2年分のタスクが表示される
- 例: 毎年12/25 → 去年12/25・今年12/25を生成（今日が12/26以降の場合）

## 実装方針

```typescript
// 日次: 過去3日〜今日
const dailyStart = subtractDays(today, 2)
const dailyEnd = today

// 週次: 過去14日〜今日
const weeklyStart = subtractDays(today, 14)
const weeklyEnd = today

// 月次: 過去60日〜今日
const monthlyStart = subtractDays(today, 60)
const monthlyEnd = today

// 年次: 過去730日〜今日
const yearlyStart = subtractDays(today, 730)
const yearlyEnd = today
```

## 未来タスクの扱い

### 削除対象
- **明日以降のタスク**（due_date > today）を毎回削除

### 理由
- 未来のタスクは「今日」にならないと必要ない
- 事前生成すると無限に蓄積する
- ユーザーが見るのは「今日やるべきタスク」のみ

### 例外
- 通常タスク（繰り返しでないタスク）は未来でもOK
- 繰り返しタスクのみ未来生成を禁止

## メリット

1. ✅ データベース肥大化防止
2. ✅ 過去のタスクを見逃さない
3. ✅ 長期間アクセスがなくても安全
4. ✅ 毎日のアクセスで常に最新状態
